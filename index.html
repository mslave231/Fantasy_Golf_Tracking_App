<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Golf League Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      min-height: 100%;
      background: #0f1e36;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #e0e6ed;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, #1a2a4a 0%, #0d1b30 100%);
      border-bottom: 3px solid #2ecc71;
      padding: 20px 32px;
      text-align: center;
    }
    .header h1 { font-size: 26px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
    .header .subtitle { font-size: 13px; color: #7f8c9b; margin-top: 4px; }

    /* ===== PANELS ===== */
    .standings-panel, .current-week-panel {
      background: #0f1e36;
      border-bottom: 1px solid #1a2a4a;
      padding: 14px 24px;
    }
    .standings-title, .current-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #7f8c9b;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .last-event-control, .current-event-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      color: #7f8c9b;
      flex-wrap: wrap;
    }
    .last-event-control select, .current-event-control select {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #2a3a5c;
      background: #162240;
      color: #e0e6ed;
      font-size: 13px;
      cursor: pointer;
    }
    .refresh-btn {
      padding: 6px 14px;
      background: #2ecc71;
      color: #0a1628;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
    }
    .refresh-btn:hover { background: #27ae60; }

    /* ===== LEADERBOARD TABLES ===== */
    .leaderboard-table, .current-week-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    .leaderboard-table th, .current-week-table th {
      background: #162240;
      padding: 8px 6px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #7f8c9b;
      border-bottom: 2px solid #2a3a5c;
    }
    .leaderboard-table td, .current-week-table td {
      padding: 10px 6px;
      border-bottom: 1px solid #1a2a4a;
    }
    .leaderboard-table tbody tr:hover, .current-week-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }
    .leaderboard-table .rank { text-align: center; font-weight: 700; width: 60px; }
    .leaderboard-table .name { text-align: left; font-weight: 600; color: #fff; }
    .leaderboard-table .money, .leaderboard-table .back, .leaderboard-table .cuts,
    .current-week-table .pos, .current-week-table .total, .current-week-table .thru, .current-week-table .today {
      text-align: center; font-weight: 700;
    }
    .leaderboard-table .money { color: #2ecc71; }
    .leaderboard-table .back { color: #f39c12; font-weight: 600; }
    .leaderboard-table .back.negative { color: #e74c3c; }
    .leaderboard-table .cuts, .current-week-table .cut { color: #e74c3c; font-weight: 600; }
    .leaderboard-table tr.leader {
      background: rgba(241, 196, 15, 0.1);
    }
    .leaderboard-table tr.leader .rank, .leaderboard-table tr.leader .name {
      color: #f1c40f; font-weight: 700;
    }
    .current-week-table .player, .current-week-table .golfer {
      text-align: left; font-weight: 600; color: #fff;
    }
    .current-week-table .cut-row { opacity: 0.7; }

    /* ===== CONTROLS BAR ===== */
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 24px;
      background: #0d1b30;
      border-bottom: 1px solid #1a2a4a;
      flex-wrap: wrap;
    }
    .controls select, .controls button {
      padding: 7px 10px;
      border-radius: 6px;
      border: 1px solid #2a3a5c;
      background: #162240;
      color: #e0e6ed;
      font-size: 13px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    .controls select:focus, .controls button:hover { border-color: #2ecc71; }
    .btn-score { background: #2ecc71 !important; color: #0a1628 !important; font-weight: 700; border-color: #27ae60 !important; }
    .btn-score:hover { background: #27ae60 !important; }
    .btn-danger { border-color: #e74c3c !important; color: #e74c3c !important; }
    .btn-danger:hover { background: rgba(231, 76, 60, 0.15) !important; }
    .controls-spacer { flex: 1; }
    .score-status { font-size: 12px; color: #7f8c9b; margin-left: 6px; }

    /* ===== GRID ===== */
    .grid-wrapper {
      overflow-x: auto;
      overflow-y: hidden;
      margin: 0;
      padding: 0 24px 16px;
      background: #0f1e36;
      position: relative;
    }
    #fantasyGrid {
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      width: 100%;
      min-width: 100%;
    }
    #fantasyGrid thead th {
      background: #162240;
      padding: 10px 6px;
      font-weight: 600;
      font-size: 10px;
      letter-spacing: 0.6px;
      color: #7f8c9b;
      border-bottom: 2px solid #2a3a5c;
      border-right: 1px solid #1a2a4a;
      text-align: center;
      white-space: normal;
      min-width: 110px;
      max-width: 130px;
      line-height: 1.4;
      position: sticky;
      top: 0;
      z-index: 12;
    }
    #fantasyGrid thead th .th-purse {
      display: block;
      font-size: 9px;
      font-weight: 400;
      color: #2ecc71;
      letter-spacing: 0;
      text-transform: none;
      margin-top: 3px;
    }
    #fantasyGrid thead th .th-date {
      display: block;
      font-size: 9px;
      font-weight: 500;
      color: #9fb0c2;
      letter-spacing: 0;
      text-transform: none;
      margin-top: 2px;
    }
    #fantasyGrid thead th .th-purse.est { color: #7f8c9b; }
    #fantasyGrid thead th.major {
      border-top: 3px solid #f1c40f;
      color: #f1c40f;
    }
    #fantasyGrid thead th.major .th-purse { color: #d4ac0d; }
    #fantasyGrid thead th.major .th-purse.est { color: #7f8c9b; }
    #fantasyGrid thead th.scored::after {
      content: ' \2713';
      color: #2ecc71;
      font-size: 11px;
    }
    #fantasyGrid thead th.sticky-col {
      position: sticky;
      left: 0;
      z-index: 30;
      background: #0f1e36;
      box-shadow: 2px 0 0 #2a3a5c;
      min-width: 140px;
      text-align: left;
      padding-left: 14px;
    }
    #fantasyGrid thead th.sticky-right {
      position: sticky;
      right: 0;
      z-index: 30;
      background: #0f1e36;
      box-shadow: -2px 0 0 #2a3a5c;
      min-width: 100px;
    }
    #fantasyGrid tbody td {
      padding: 0;
      border-bottom: 1px solid #1a2a4a;
      border-right: 1px solid #1a2a4a;
      vertical-align: middle;
    }
    #fantasyGrid tbody td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 20;
      background: #0f1e36;
      overflow: hidden;
      padding: 10px 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      min-width: 140px;
      border-right: 2px solid #2a3a5c;
    }
    #fantasyGrid tbody td.sticky-col:hover { background: #162240; }
    #fantasyGrid tbody td.sticky-right {
      position: sticky;
      right: 0;
      z-index: 20;
      background: #0f1e36;
      overflow: hidden;
      padding: 10px 8px;
      text-align: center;
      font-weight: 700;
      color: #2ecc71;
      font-size: 14px;
      border-left: 2px solid #2a3a5c;
      min-width: 100px;
    }

    /* Pick cells */
    .pick-cell {
      min-width: 110px;
      max-width: 130px;
      text-align: center;
      cursor: pointer;
      padding: 6px 5px;
      transition: background 0.15s;
      height: 52px;
    }
    .pick-cell:hover { background: rgba(46, 204, 113, 0.07); }
    .pick-cell.empty { color: #2a3a5c; font-size: 18px; line-height: 40px; }
    .pick-cell.empty:hover { color: #2ecc71; }
    .pick-golfer {
      font-size: 11px;
      color: #c0c8d0;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
      margin: 0 auto;
    }
    .pick-position { font-size: 10px; color: #f39c12; font-weight: 600; margin-top: 1px; }
    .pick-earnings { font-size: 11px; color: #2ecc71; font-weight: 700; margin-top: 1px; }
    .pick-earnings.zero { color: #7f8c9b; }
    .pick-not-found { font-size: 9px; color: #e74c3c; margin-top: 1px; }

    /* Row hover */
    #fantasyGrid tbody tr:hover td:not(.sticky-col):not(.sticky-right) {
      background: rgba(255,255,255,0.02);
    }

    /* ===== MODALS ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #162240;
      border: 1px solid #2a3a5c;
      border-radius: 10px;
      padding: 24px;
      max-width: 480px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
    }
    .modal h2 { font-size: 16px; color: #fff; margin-bottom: 4px; }
    .modal .modal-sub { font-size: 12px; color: #7f8c9b; margin-bottom: 16px; }
    .modal label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #7f8c9b;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .modal input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid #2a3a5c;
      background: #0f1e36;
      color: #fff;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }
    .modal input[type="text"]:focus { border-color: #2ecc71; }
    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .modal-actions button {
      padding: 8px 20px;
      border-radius: 6px;
      border: 1px solid #2a3a5c;
      background: #0f1e36;
      color: #e0e6ed;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .modal-actions button:hover { border-color: #2ecc71; }
    .modal-actions .btn-primary {
      background: #2ecc71;
      color: #0a1628;
      font-weight: 700;
      border-color: #27ae60;
    }
    .modal-actions .btn-primary:hover { background: #27ae60; }
    .modal-actions .btn-clear { color: #e74c3c; border-color: #e74c3c; }
    .validation-msg { color: #e74c3c; font-size: 12px; margin-top: 8px; display: none; }
    .used-golfers { margin-top: 14px; max-height: 150px; overflow-y: auto; }
    .used-golfers-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #7f8c9b;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .used-golfers ul {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .used-golfers li {
      background: #0f1e36;
      border: 1px solid #2a3a5c;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 11px;
      color: #a0aab5;
    }

    /* Score results table */
    .score-results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 12px;
    }
    .score-results-table th {
      text-align: left;
      padding: 8px 6px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: #7f8c9b;
      border-bottom: 1px solid #2a3a5c;
    }
    .score-results-table td {
      padding: 6px 6px;
      border-bottom: 1px solid #1a2a4a;
    }
    .score-results-table tr.not-found td { color: #e74c3c; opacity: 0.7; }
    .score-results-table .earnings { color: #2ecc71; font-weight: 600; text-align: right; }
    .score-results-table th.right { text-align: right; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .standings-panel, .current-week-panel, .controls { padding-left: 12px; padding-right: 12px; }
      .grid-wrapper { padding: 0 12px 12px; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls-spacer { display: none; }
      .header h1 { font-size: 20px; }
      .last-event-control, .current-event-control { flex-direction: column; align-items: flex-start; }
    }

    /* Auto-refresh controls */
    .auto-refresh-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      color: #7f8c9b;
      flex-wrap: wrap;
    }
    .auto-refresh-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }
    .auto-refresh-toggle input[type="checkbox"] {
      accent-color: #2ecc71;
      cursor: pointer;
      width: 14px;
      height: 14px;
    }
    .auto-refresh-toggle label {
      cursor: pointer;
      font-weight: 600;
      color: #7f8c9b;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .auto-refresh-countdown {
      color: #2ecc71;
      font-weight: 600;
      font-size: 11px;
    }
    .auto-refresh-countdown.paused {
      color: #7f8c9b;
    }
    .last-updated {
      color: #7f8c9b;
      font-size: 11px;
      margin-left: auto;
    }
    .last-updated .time-ago {
      color: #9fb0c2;
      font-weight: 600;
    }

    /* Hidden file input */
    #importInput { display: none; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <h1>Fantasy Golf League Tracker</h1>
    <div class="subtitle">2026 PGA Tour Season &mdash; Sony Open through PGA Championship</div>
  </div>

  <!-- SEASON STANDINGS -->
  <div class="standings-panel">
    <div class="standings-title">Season Leaderboard</div>
    <div class="last-event-control">
      <span>Latest Event:</span>
      <select id="lastEventSelect" onchange="renderStandings()"></select>
    </div>
    <div id="standingsContainer"></div>
  </div>

  <!-- CURRENT WEEK LIVE LEADERBOARD -->
  <div class="current-week-panel">
    <div class="current-title">Current Week Live Leaderboard</div>
    <div class="current-event-control">
      <span>Event:</span>
      <select id="currentWeekSelect"></select>
      <button class="refresh-btn" onclick="loadCurrentWeekLeaderboard()">Refresh Live</button>
      <span id="currentWeekStatus" style="color:#7f8c9b;"></span>
    </div>
    <div class="auto-refresh-bar" id="autoRefreshBar" style="display:none;">
      <div class="auto-refresh-toggle">
        <input type="checkbox" id="autoRefreshCheck" checked>
        <label for="autoRefreshCheck">Auto-refresh</label>
      </div>
      <span class="auto-refresh-countdown" id="autoRefreshCountdown"></span>
      <span class="last-updated" id="lastUpdated"></span>
    </div>
    <div id="currentWeekContainer"><span style="color:#7f8c9b;">Select an event and click Refresh Live to load.</span></div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <button class="btn-score" onclick="handleScoreTournament()">Fetch Scores Through:</button>
    <select id="tournamentSelect"></select>
    <span class="score-status" id="scoreStatus"></span>
    <div class="controls-spacer"></div>
    <button onclick="exportData()">Export JSON</button>
    <button onclick="document.getElementById('importInput').click()">Import JSON</button>
    <input type="file" id="importInput" accept=".json" onchange="importData(event)">
    <button class="btn-danger" onclick="resetAllData()">Reset</button>
  </div>

  <!-- GRID -->
  <div class="grid-wrapper">
    <table id="fantasyGrid">
      <thead><tr id="gridHeader"></tr></thead>
      <tbody id="gridBody"></tbody>
    </table>
  </div>

  <!-- PICK ENTRY MODAL -->
  <div class="modal-overlay" id="pickModal">
    <div class="modal">
      <h2 id="pickModalTitle">Enter Pick</h2>
      <div class="modal-sub" id="pickModalSub"></div>
      <label for="golferInput">Golfer Name</label>
      <input type="text" id="golferInput" placeholder="e.g. Scottie Scheffler" autocomplete="off">
      <div class="validation-msg" id="validationMsg"></div>
      <div class="used-golfers" id="usedGolfersSection">
        <div class="used-golfers-title">Already picked this season:</div>
        <ul id="usedGolfersList"></ul>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" onclick="savePick()">Save</button>
        <button class="btn-clear" onclick="clearPick()">Clear Pick</button>
        <button onclick="closePickModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- SCORE RESULTS MODAL -->
  <div class="modal-overlay" id="scoreResultsModal">
    <div class="modal">
      <h2 id="scoreResultsTitle">Scoring Results</h2>
      <div class="modal-sub" id="scoreResultsSub"></div>
      <table class="score-results-table">
        <thead>
          <tr>
            <th>Participant</th>
            <th>Golfer</th>
            <th>Pos</th>
            <th class="right">Earnings</th>
          </tr>
        </thead>
        <tbody id="scoreResultsBody"></tbody>
      </table>
      <div class="modal-actions" style="margin-top:18px;">
        <button class="btn-primary" onclick="closeScoreResultsModal()">Done</button>
      </div>
    </div>
  </div>

<script>
// ===== CONSTANTS =====
const TOURNAMENTS = [
  { id: "401811928", name: "Sony Open in Hawaii", dates: "Jan 15–18, 2026", abbr: "SON", isMajor: false, purse: "$9,100,000", purseEst: false },
  { id: "401811929", name: "The American Express", dates: "Jan 22–25, 2026", abbr: "AMX", isMajor: false, purse: "$9,200,000", purseEst: false },
  { id: "401811930", name: "Farmers Insurance Open", dates: "Jan 29–Feb 1, 2026", abbr: "FIO", isMajor: false, purse: "$9,600,000", purseEst: false },
  { id: "401811931", name: "WM Phoenix Open", dates: "Feb 5–8, 2026", abbr: "PHX", isMajor: false, purse: "$9,600,000", purseEst: false },
  { id: "401811932", name: "AT&T Pebble Beach Pro-Am", dates: "Feb 12–15, 2026", abbr: "PBP", isMajor: false, purse: "$20,000,000", purseEst: false },
  { id: "401811933", name: "The Genesis Invitational", dates: "Feb 19–22, 2026", abbr: "GEN", isMajor: false, purse: "$20,000,000", purseEst: false },
  { id: "401811934", name: "Cognizant Classic in The Palm Beaches", dates: "Feb 26–Mar 1, 2026", abbr: "COG", isMajor: false, purse: "$9,600,000", purseEst: false },
  { id: "401811935", name: "Arnold Palmer Invitational", dates: "Mar 5–8, 2026", abbr: "API", isMajor: false, purse: "$20,000,000", purseEst: false },
  { id: "401811936", name: "Puerto Rico Open", dates: "Mar 5–8, 2026", abbr: "PRO", isMajor: false, purse: "$4,000,000", purseEst: false },
  { id: "401811937", name: "THE PLAYERS Championship", dates: "Mar 12–15, 2026", abbr: "TPC", isMajor: false, purse: "$25,000,000", purseEst: false },
  { id: "401811938", name: "Valspar Championship", dates: "Mar 19–22, 2026", abbr: "VAL", isMajor: false, purse: "$9,100,000", purseEst: false },
  { id: "401811939", name: "Texas Children's Houston Open", dates: "Mar 26–29, 2026", abbr: "HOU", isMajor: false, purse: "$9,900,000", purseEst: false },
  { id: "401811940", name: "Valero Texas Open", dates: "Apr 2–5, 2026", abbr: "TXO", isMajor: false, purse: "$9,800,000", purseEst: false },
  { id: "401811941", name: "Masters Tournament", dates: "Apr 9–12, 2026", abbr: "MAS", isMajor: true, purse: "$21,000,000", purseEst: true },
  { id: "401811942", name: "RBC Heritage", dates: "Apr 16–19, 2026", abbr: "HER", isMajor: false, purse: "$20,000,000", purseEst: false },
  { id: "401811943", name: "Zurich Classic of New Orleans", dates: "Apr 23–26, 2026", abbr: "ZUR", isMajor: false, purse: "$9,500,000", purseEst: false },
  { id: "401811944", name: "Cadillac Championship", dates: "Apr 30–May 3, 2026", abbr: "CAD", isMajor: false, purse: "$20,000,000", purseEst: false },
  { id: "401811945", name: "Truist Championship", dates: "May 7–10, 2026", abbr: "TRU", isMajor: false, purse: "$20,000,000", purseEst: false },
  { id: "401811946", name: "ONEflight Myrtle Beach Classic", dates: "May 7–10, 2026", abbr: "MYR", isMajor: false, purse: "$4,000,000", purseEst: false },
  { id: "401811947", name: "PGA Championship", dates: "May 14–17, 2026", abbr: "PGA", isMajor: true, purse: "$19,000,000", purseEst: true },
];


// Standard PGA Tour payout percentages (positions 1-65)
const PGA_STANDARD_PCT = [
  18.000, 10.900, 6.900, 4.900, 4.100, 3.625, 3.375, 3.125, 2.925, 2.725,
  2.525, 2.325, 2.125, 1.925, 1.825, 1.725, 1.625, 1.525, 1.425, 1.325,
  1.225, 1.125, 1.045, 0.965, 0.885, 0.805, 0.775, 0.745, 0.715, 0.685,
  0.655, 0.625, 0.595, 0.570, 0.545, 0.520, 0.495, 0.475, 0.455, 0.435,
  0.415, 0.395, 0.375, 0.355, 0.335, 0.315, 0.295, 0.279, 0.265, 0.257,
  0.251, 0.245, 0.241, 0.237, 0.235, 0.233, 0.231, 0.229, 0.227, 0.225,
  0.223, 0.221, 0.219, 0.217, 0.215
];

// Masters payout percentages (positions 1-50, winner gets 20%)
const MASTERS_PCT = [
  20.000, 10.800, 6.800, 4.800, 4.000, 3.600, 3.350, 3.100, 2.900, 2.700,
  2.500, 2.300, 2.100, 1.900, 1.800, 1.700, 1.600, 1.500, 1.400, 1.300,
  1.200, 1.120, 1.040, 0.960, 0.880, 0.800, 0.770, 0.740, 0.710, 0.680,
  0.650, 0.620, 0.590, 0.570, 0.540, 0.520, 0.490, 0.470, 0.450, 0.430,
  0.410, 0.390, 0.370, 0.350, 0.330, 0.310, 0.290, 0.274, 0.260, 0.252
];

// Zurich Classic team payout percentages (per player, positions 1-36 teams)
// Teams combine adjacent individual positions, split evenly
const ZURICH_TEAM_PCT = [
  14.450, 5.900, 3.863, 2.838, 2.838, 2.838, 2.838, 1.675, 1.675, 1.275,
  1.275, 0.915, 0.915, 0.915, 0.915, 0.915, 0.915, 0.545, 0.545, 0.545,
  0.545, 0.545, 0.545, 0.398, 0.398, 0.365, 0.365, 0.330, 0.330, 0.330,
  0.310, 0.295, 0.295, 0.295, 0.280, 0.275
];

const STORAGE_KEY = 'fantasyGolfLeague';
const DATA_VERSION = '2026-v3';

// ===== STATE =====
let state = {
  participants: ['Andrew Vlosak', 'Van Ainalakis', 'Joe Vlosak', 'Ben Wilson', 'Kevin Fleck', 'Bryan Stresney', 'Matt Slavik'],
  picks: {
    '0-401811928': { golfer: 'Si Woo Kim', earnings: null, position: null },
    '0-401811929': { golfer: 'Matt Fitzpatrick', earnings: null, position: null },
    '0-401811930': { golfer: 'Max Greyserman', earnings: null, position: null },
    '0-401811931': { golfer: 'Scottie Scheffler', earnings: null, position: null },
    '0-401811932': { golfer: 'Chris Gotterup', earnings: null, position: null },
    '0-401811933': { golfer: 'Hideki Matsuyama', earnings: null, position: null },

    '1-401811928': { golfer: 'Keegan Bradley', earnings: null, position: null },
    '1-401811929': { golfer: 'J.T. Poston', earnings: null, position: null },
    '1-401811930': { golfer: 'Wyndham Clark', earnings: null, position: null },
    '1-401811931': { golfer: 'Cameron Young', earnings: null, position: null },
    '1-401811932': { golfer: 'Russell Henley', earnings: null, position: null },
    '1-401811933': { golfer: 'Jake Knapp', earnings: null, position: null },

    '2-401811928': { golfer: 'Ben Griffin', earnings: null, position: null },
    '2-401811929': { golfer: 'Robert MacIntyre', earnings: null, position: null },
    '2-401811930': { golfer: 'Chris Gotterup', earnings: null, position: null },
    '2-401811931': { golfer: 'Maverick McNealy', earnings: null, position: null },
    '2-401811932': { golfer: 'Si Woo Kim', earnings: null, position: null },
    '2-401811933': { golfer: 'Rory McIlroy', earnings: null, position: null },

    '3-401811928': { golfer: 'Ben Griffin', earnings: null, position: null },
    '3-401811929': { golfer: 'Russell Henley', earnings: null, position: null },
    '3-401811930': { golfer: 'Ludvig Åberg', earnings: null, position: null },
    '3-401811931': { golfer: 'Xander Schauffele', earnings: null, position: null },
    '3-401811932': { golfer: 'Scottie Scheffler', earnings: null, position: null },
    '3-401811933': { golfer: 'Tommy Fleetwood', earnings: null, position: null },

    '4-401811928': { golfer: 'Ben Griffin', earnings: null, position: null },
    '4-401811929': { golfer: 'Sepp Straka', earnings: null, position: null },
    '4-401811930': { golfer: 'Jason Day', earnings: null, position: null },
    '4-401811931': { golfer: 'Jake Knapp', earnings: null, position: null },
    '4-401811932': { golfer: 'Scottie Scheffler', earnings: null, position: null },
    '4-401811933': { golfer: 'Tommy Fleetwood', earnings: null, position: null },

    '5-401811928': { golfer: 'Harry Hall', earnings: null, position: null },
    '5-401811929': { golfer: 'Si Woo Kim', earnings: null, position: null },
    '5-401811930': { golfer: 'Sam Stevens', earnings: null, position: null },
    '5-401811931': { golfer: 'Cameron Young', earnings: null, position: null },
    '5-401811932': { golfer: 'Akshay Bhatia', earnings: null, position: null },
    '5-401811933': { golfer: 'Tommy Fleetwood', earnings: null, position: null },

    '6-401811928': { golfer: 'Collin Morikawa', earnings: null, position: null },
    '6-401811929': { golfer: 'Patrick Cantlay', earnings: null, position: null },
    '6-401811930': { golfer: 'Chris Gotterup', earnings: null, position: null },
    '6-401811931': { golfer: 'Ben Griffin', earnings: null, position: null },
    '6-401811932': { golfer: 'Tommy Fleetwood', earnings: null, position: null },
    '6-401811933': { golfer: 'Si Woo Kim', earnings: null, position: null },

    '0-401811934': { golfer: 'Christiaan Bezuidenhout', earnings: null, position: null },
    '1-401811934': { golfer: 'Eric Cole', earnings: null, position: null },
    '2-401811934': { golfer: 'Aaron Rai', earnings: null, position: null },
    '3-401811934': { golfer: 'Shane Lowry', earnings: null, position: null },
    '4-401811934': { golfer: 'Shane Lowry', earnings: null, position: null },
    '5-401811934': { golfer: 'Aaron Rai', earnings: null, position: null },
    '6-401811934': { golfer: 'Shane Lowry', earnings: null, position: null }
  },
  scoredTournaments: []
};

// ===== LOCALSTORAGE =====
function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (parsed.version !== DATA_VERSION) {
        console.warn('Data version mismatch, resetting to fresh state for 2026 season.');
        saveState();
        return;
      }
      state.participants = parsed.participants || state.participants;
      state.picks = parsed.picks || {};
      state.scoredTournaments = parsed.scoredTournaments || [];
    } catch (e) {
      console.error('Failed to load saved state:', e);
    }
  }
}

function saveState() {
  const toSave = { ...state, version: DATA_VERSION };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
}

// ===== UTILITIES =====
function formatMoney(amount) {
  if (amount == null) return '-';
  if (amount === 0) return '$0';
  return '$' + amount.toLocaleString('en-US');
}

function formatBackMoney(amount) {
  if (amount == null || amount === 0) return '-';
  return `(${formatMoney(amount)})`;
}

function parseEarnings(str) {
  if (!str || str === '--' || str === '-') return 0;
  return parseInt(str.replace(/[$,]/g, ''), 10) || 0;
}

function getOrdinal(n) {
  if (n === 1) return '1st';
  if (n === 2) return '2nd';
  if (n === 3) return '3rd';
  return `${n}th`;
}

// ===== RENDERING =====
function renderAll() {
  renderHeader();
  renderGrid();
  populateTournamentSelect();
  populateLastEventSelect();
  renderStandings();
  populateCurrentWeekSelect();
  loadCurrentWeekLeaderboard();
}

function renderHeader() {
  const headerRow = document.getElementById('gridHeader');
  headerRow.innerHTML = '';

  const thName = document.createElement('th');
  thName.className = 'sticky-col';
  thName.textContent = 'Participant';
  headerRow.appendChild(thName);

  TOURNAMENTS.forEach(t => {
    const th = document.createElement('th');
    th.dataset.tid = t.id;
    th.title = t.name;

    const nameSpan = document.createElement('span');
    nameSpan.textContent = t.name;
    th.appendChild(nameSpan);

    const dateSpan = document.createElement('span');
    dateSpan.className = 'th-date';
    dateSpan.textContent = t.dates || '';
    th.appendChild(dateSpan);

    const purseSpan = document.createElement('span');
    purseSpan.className = 'th-purse' + (t.purseEst ? ' est' : '');
    purseSpan.textContent = (t.purseEst ? 'Est. ' : '') + t.purse;
    th.appendChild(purseSpan);

    if (t.isMajor) th.classList.add('major');
    if (state.scoredTournaments.includes(t.id)) th.classList.add('scored');
    headerRow.appendChild(th);
  });

  const thTotal = document.createElement('th');
  thTotal.className = 'sticky-right';
  thTotal.textContent = 'TOTAL';
  headerRow.appendChild(thTotal);
}

function renderGrid() {
  const tbody = document.getElementById('gridBody');
  tbody.innerHTML = '';

  state.participants.forEach((name, pIdx) => {
    const tr = document.createElement('tr');

    const nameTd = document.createElement('td');
    nameTd.className = 'sticky-col';
    nameTd.textContent = name;
    nameTd.title = 'Double-click to edit name';
    nameTd.addEventListener('dblclick', () => editParticipantName(pIdx));
    tr.appendChild(nameTd);

    let totalEarnings = 0;
    TOURNAMENTS.forEach(t => {
      const td = document.createElement('td');
      td.className = 'pick-cell';

      const key = `${pIdx}-${t.id}`;
      const pick = state.picks[key];

      if (pick) {
        const golferDiv = document.createElement('div');
        golferDiv.className = 'pick-golfer';
        golferDiv.textContent = pick.golfer;
        golferDiv.title = pick.golfer;
        td.appendChild(golferDiv);

        if (pick.earnings != null) {
          const posDiv = document.createElement('div');
          posDiv.className = 'pick-position';
          if (pick.position === 'NF') {
            posDiv.textContent = 'Not Found';
            posDiv.style.color = '#e74c3c';
          } else if (pick.earnings === 0) {
            posDiv.textContent = 'CUT';
            posDiv.style.color = '#e74c3c';
          } else if (pick.position) {
            posDiv.textContent = pick.position;
          }
          if (posDiv.textContent) td.appendChild(posDiv);

          const earningsDiv = document.createElement('div');
          earningsDiv.className = 'pick-earnings';
          if (pick.earnings === 0) earningsDiv.classList.add('zero');
          earningsDiv.textContent = formatMoney(pick.earnings);
          td.appendChild(earningsDiv);
          totalEarnings += pick.earnings;
        }
      } else {
        td.classList.add('empty');
        td.textContent = '+';
      }

      td.addEventListener('click', () => openPickModal(pIdx, t.id));
      tr.appendChild(td);
    });

    const totalTd = document.createElement('td');
    totalTd.className = 'sticky-right';
    totalTd.textContent = formatMoney(totalEarnings) || '$0';
    tr.appendChild(totalTd);

    tbody.appendChild(tr);
  });
}

function populateLastEventSelect() {
  const select = document.getElementById('lastEventSelect');
  select.innerHTML = '';

  const latestId = getMostRecentPositiveEarningsTournamentId();

  TOURNAMENTS.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    const scored = state.scoredTournaments.includes(t.id);
    opt.textContent = `${t.name}${t.isMajor ? ' (Major)' : ''}${scored ? ' ✓' : ''}`;
    select.appendChild(opt);
  });

  select.value = latestId || TOURNAMENTS[TOURNAMENTS.length - 1].id;
}

function getMostRecentPositiveEarningsTournamentId() {
  for (let i = TOURNAMENTS.length - 1; i >= 0; i--) {
    const tId = TOURNAMENTS[i].id;
    for (let pIdx = 0; pIdx < state.participants.length; pIdx++) {
      const pick = state.picks[`${pIdx}-${tId}`];
      if (pick && pick.earnings != null && pick.earnings > 0) {
        return tId;
      }
    }
  }

  for (let i = TOURNAMENTS.length - 1; i >= 0; i--) {
    if (state.scoredTournaments.includes(TOURNAMENTS[i].id)) {
      return TOURNAMENTS[i].id;
    }
  }

  return null;
}

function renderStandings() {
  const container = document.getElementById('standingsContainer');
  container.innerHTML = '';

  const participantStats = state.participants.map((name, pIdx) => {
    let totalEarnings = 0;
    let missedCuts = 0;

    TOURNAMENTS.forEach(t => {
      const key = `${pIdx}-${t.id}`;
      const pick = state.picks[key];
      if (pick && pick.earnings != null) {
        totalEarnings += pick.earnings;
        if (pick.earnings === 0 && pick.position !== 'NF') {
          missedCuts++;
        }
      }
    });

    return { name, pIdx, totalEarnings, missedCuts, lastEarnings: 0 };
  });

  if (participantStats.every(s => s.totalEarnings === 0)) {
    container.innerHTML = '<span style="color:#7f8c9b;font-size:12px;">No scores yet. Enter picks and fetch tournament scores to see standings.</span>';
    return;
  }

  participantStats.sort((a, b) => b.totalEarnings - a.totalEarnings);

  let rank = 1;
  participantStats.forEach((s, i) => {
    if (i > 0 && s.totalEarnings !== participantStats[i - 1].totalEarnings) {
      rank = i + 1;
    }
    s.rank = rank;
    s.ordinal = getOrdinal(rank);
  });

  const leaderTotal = participantStats[0].totalEarnings;

  const lastEventSelect = document.getElementById('lastEventSelect');
  let selectedTid = lastEventSelect.value;
  if (!selectedTid) {
    selectedTid = getMostRecentPositiveEarningsTournamentId() || TOURNAMENTS[TOURNAMENTS.length - 1].id;
    lastEventSelect.value = selectedTid;
  }
  const selectedTournament = TOURNAMENTS.find(t => t.id === selectedTid);

  participantStats.forEach(s => {
    const key = `${s.pIdx}-${selectedTid}`;
    const pick = state.picks[key];
    s.lastEarnings = (pick && pick.earnings != null) ? pick.earnings : 0;
  });

  let tableHTML = '<table class="leaderboard-table"><thead><tr>';
  tableHTML += '<th style="text-align:center;">Rank</th>';
  tableHTML += '<th style="text-align:left;">Player</th>';
  tableHTML += `<th style="text-align:center;">Latest Event${selectedTournament ? ' (' + selectedTournament.abbr + ')' : ''}</th>`;
  tableHTML += '<th style="text-align:center;">Total</th>';
  tableHTML += '<th style="text-align:center;">Back</th>';
  tableHTML += '<th style="text-align:center;">Missed Cuts</th>';
  tableHTML += '</tr></thead><tbody>';

  participantStats.forEach(s => {
    const isLeader = s.totalEarnings === leaderTotal;
    const backAmount = leaderTotal - s.totalEarnings;
    const back = isLeader ? '-' : formatBackMoney(backAmount);
    const backClass = isLeader ? 'back' : 'back negative';
    const cutsDisplay = s.missedCuts === 0 ? '-' : s.missedCuts;

    tableHTML += `<tr${isLeader ? ' class="leader"' : ''}>`;
    tableHTML += `<td class="rank">${s.ordinal}</td>`;
    tableHTML += `<td class="name">${s.name}</td>`;
    tableHTML += `<td class="money">${formatMoney(s.lastEarnings)}</td>`;
    tableHTML += `<td class="money">${formatMoney(s.totalEarnings)}</td>`;
    tableHTML += `<td class="${backClass}">${back}</td>`;
    tableHTML += `<td class="cuts">${cutsDisplay}</td>`;
    tableHTML += '</tr>';
  });

  tableHTML += '</tbody></table>';
  container.innerHTML = tableHTML;
}

function getMostRecentTournamentWithAnyPickId() {
  for (let i = TOURNAMENTS.length - 1; i >= 0; i--) {
    const tId = TOURNAMENTS[i].id;
    for (let pIdx = 0; pIdx < state.participants.length; pIdx++) {
      const pick = state.picks[`${pIdx}-${tId}`];
      if (pick && pick.golfer && pick.golfer.trim()) {
        return tId;
      }
    }
  }

  return null;
}

function populateCurrentWeekSelect() {
  const select = document.getElementById('currentWeekSelect');
  select.innerHTML = '';

  const latestPickedId = getMostRecentTournamentWithAnyPickId();

  TOURNAMENTS.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    const scored = state.scoredTournaments.includes(t.id);
    opt.textContent = `${t.name}${t.isMajor ? ' (Major)' : ''}${scored ? ' ✓' : ''}`;
    select.appendChild(opt);
  });

  select.value = latestPickedId || TOURNAMENTS[TOURNAMENTS.length - 1].id;
}

async function loadCurrentWeekLeaderboard() {
  const select = document.getElementById('currentWeekSelect');
  const tId = select.value;
  if (!tId) return;

  const tournament = TOURNAMENTS.find(t => t.id === tId);
  const statusEl = document.getElementById('currentWeekStatus');
  const container = document.getElementById('currentWeekContainer');

  statusEl.textContent = 'Fetching live data...';
  statusEl.style.color = '#7f8c9b';
  container.innerHTML = 'Loading...';

  try {
    const url = `https://site.api.espn.com/apis/site/v2/sports/golf/leaderboard?event=${tId}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch');
    const data = await res.json();

    const tournamentStatus = data.events?.[0]?.status?.type?.name || '';
    const competitors = data.events?.[0]?.competitions?.[0]?.competitors || [];

    const formatTeeTime = (competitor) => {
      const teeTime = competitor?.status?.teeTime || competitor?.teeTime;
      if (teeTime) {
        const teeDate = new Date(teeTime);
        return teeDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      }
      return null;
    };

    const isTeeTimeDisplay = (thruValue) => {
      return thruValue && /\d{1,2}:\d{2}\s*(AM|PM)/i.test(thruValue);
    };

    const getThruDisplay = (competitor) => {
      if (competitor?.status?.thru != null) {
        if (competitor.status.thru < 1) {
          return formatTeeTime(competitor) || '--';
        }
        return competitor.status.thru >= 18 ? 'F' : competitor.status.thru.toString();
      }

      if (competitor?.status?.hole != null) {
        if (competitor.status.hole < 1) {
          return formatTeeTime(competitor) || '--';
        }
        return competitor.status.hole >= 18 ? 'F' : competitor.status.hole.toString();
      }

      if (competitor?.status?.displayThru) {
        return competitor.status.displayThru;
      }

      if (competitor?.thru != null) {
        if (competitor.thru < 1) {
          return formatTeeTime(competitor) || '--';
        }
        return competitor.thru >= 18 ? 'F' : competitor.thru.toString();
      }

      const detail = competitor?.status?.displayValue || competitor?.status?.detail || competitor?.status?.type?.detail || '';
      const detailLower = detail.toLowerCase();
      const thruMatch = detailLower.match(/(?:thru|through)\s*(\d{1,2})/);
      if (thruMatch) return thruMatch[1];

      return '--';
    };

    const getTotalScoreDisplay = (competitor) => {
      // Use statistics[0] scoreToPar for the overall tournament total
      const scoreToParStat = (competitor?.statistics || []).find(s => s?.name === 'scoreToPar' && s?.displayValue != null);
      if (scoreToParStat && scoreToParStat.displayValue !== '-' && scoreToParStat.displayValue !== '--') {
        return scoreToParStat.displayValue;
      }

      // Fallback to score.displayValue (also the tournament total)
      if (competitor?.score?.displayValue && competitor.score.displayValue !== '-') {
        return competitor.score.displayValue;
      }

      return '--';
    };

    const getTodayScoreDisplay = (competitor) => {
      // Parse status.detail for today's score format like "-1(5)" meaning -1 thru 5 holes
      const statusDetail = competitor?.status?.detail || '';
      const detailMatch = statusDetail.match(/^([+-]?\d+|E)\(\d+\)$/i);
      if (detailMatch) {
        return detailMatch[1].toUpperCase();
      }

      // Use the current round's linescore
      const currentPeriod = competitor?.status?.period;
      if (currentPeriod && competitor?.linescores) {
        const currentLine = competitor.linescores.find(line => line.period === currentPeriod);
        if (currentLine && currentLine.displayValue && currentLine.displayValue !== '-') {
          return currentLine.displayValue;
        }
      }

      return '--';
    };

    const getNumericPosition = (positionDisplay) => {
      if (!positionDisplay) return null;
      const match = positionDisplay.match(/^(?:T)?(\d{1,2})$/i);
      if (!match) return null;
      return parseInt(match[1], 10);
    };

    const parsePurseAmount = (purseText) => {
      if (!purseText) return 0;
      return parseFloat(purseText.replace(/[$,]/g, '')) || 0;
    };

    const purseAmount = parsePurseAmount(tournament?.purse);
    let payoutPctTable;
    if (tId === '401811941') {
      payoutPctTable = MASTERS_PCT;           // Masters
    } else if (tId === '401811943') {
      payoutPctTable = ZURICH_TEAM_PCT;       // Zurich Classic (team event)
    } else {
      payoutPctTable = PGA_STANDARD_PCT;      // All other events (including PGA Champ, PLAYERS, etc.)
    }

    const getRankPayout = (rank) => {
      if (!Number.isInteger(rank) || rank < 1 || rank > payoutPctTable.length) return 0;
      return Math.round(purseAmount * payoutPctTable[rank - 1] / 100);
    };

    const tieCountsByPosition = {};
    competitors.forEach(c => {
      const statusDetail = (c?.status?.type?.detail || '').toLowerCase();
      if (statusDetail.includes('cut') || statusDetail.includes('withdrawn') || statusDetail.includes('disqualified')) return;
      const posDisplay = c?.status?.position?.displayName || '';
      const posNum = getNumericPosition(posDisplay);
      if (!posNum) return;
      tieCountsByPosition[posNum] = (tieCountsByPosition[posNum] || 0) + 1;
    });

    const getEstimatedPayout = (positionDisplay) => {
      const posNum = getNumericPosition(positionDisplay);
      if (!posNum) return '--';

      const tieCount = tieCountsByPosition[posNum] || 1;
      let total = 0;
      let slots = 0;

      for (let rank = posNum; rank < posNum + tieCount; rank++) {
        const payout = getRankPayout(rank);
        if (payout <= 0) continue;
        total += payout;
        slots += 1;
      }

      if (!slots) return '--';
      return formatMoney(Math.round(total / slots));
    };

    const golferMap = {};
    competitors.forEach(c => {
      const nameLower = c.athlete.displayName.toLowerCase();
      let pos = c.status.position?.displayName || '--';
      let total = getTotalScoreDisplay(c);
      let thru = '--';
      let today = getTodayScoreDisplay(c);
      let posNum = Infinity;
      let isCut = false;

      const teeTimeValue = c.status?.teeTime || c.teeTime;
      if (tournamentStatus === 'STATUS_SCHEDULED' && teeTimeValue) {
        thru = formatTeeTime(c) || '--';
        today = '-';
      } else {
        thru = getThruDisplay(c);
        const statusDetail = (c.status.type.detail || '').toLowerCase();
        if (statusDetail.includes('cut')) {
          pos = 'CUT';
          isCut = true;
          total = '--';
          thru = '--';
          today = '--';
        } else if (statusDetail.includes('withdrawn')) {
          pos = 'WD';
          total = '--';
          thru = '--';
          today = '--';
        } else if (statusDetail.includes('disqualified')) {
          pos = 'DQ';
          total = '--';
          thru = '--';
          today = '--';
        } else {
          if (thru === '--' && teeTimeValue) {
            thru = formatTeeTime(c) || '--';
          }
          if (isTeeTimeDisplay(thru)) {
            today = '-';
          }
          posNum = parseInt(pos.replace('T', '')) || Infinity;
        }
      }

      golferMap[nameLower] = {
        displayName: c.athlete.displayName,
        pos,
        total,
        thru,
        today,
        estimatedPayout: getEstimatedPayout(pos),
        posNum,
        isCut
      };
    });

    const entries = state.participants.map((pName, pIdx) => {
      const key = `${pIdx}-${tId}`;
      const pick = state.picks[key];
      let entry = {
        player: pName,
        golfer: 'No Pick',
        pos: '--',
        total: '--',
        thru: '--',
        today: '--',
        estimatedPayout: '--',
        posNum: Infinity,
        isCut: false
      };

      if (pick) {
        entry.golfer = pick.golfer;
        let result = golferMap[pick.golfer.toLowerCase()];

        if (!result) {
          const lastName = pick.golfer.trim().split(' ').pop().toLowerCase();
          let found = null;
          for (const [key, val] of Object.entries(golferMap)) {
            if (key.endsWith(lastName)) {
              if (found) { found = null; break; }
              found = val;
            }
          }
          result = found;
        }

        if (result) {
          entry.golfer = result.displayName;
          entry.pos = result.pos;
          entry.total = result.total;
          entry.thru = result.thru;
          entry.today = result.today;
          entry.estimatedPayout = result.estimatedPayout;
          entry.posNum = result.posNum;
          entry.isCut = result.isCut;
        } else {
          entry.pos = 'NF';
        }
      }

      return entry;
    });

    entries.sort((a, b) => {
      if (a.isCut !== b.isCut) return a.isCut ? 1 : -1;
      if (a.posNum !== b.posNum) return a.posNum - b.posNum;
      return a.player.localeCompare(b.player);
    });

    let tableHTML = `<div style="text-align:center; font-size:14px; font-weight:600; margin-bottom:8px;">Current Week - ${tournament.name}</div>`;
    tableHTML += '<table class="current-week-table"><thead><tr>';
    tableHTML += '<th style="text-align:left;">Player</th>';
    tableHTML += '<th style="text-align:left;">Golfer</th>';
    tableHTML += '<th>Position</th>';
    tableHTML += '<th>Total</th>';
    tableHTML += '<th>Thru</th>';
    tableHTML += '<th>Today</th>';
    tableHTML += '<th>Est. Payout</th>';
    tableHTML += '</tr></thead><tbody>';

    entries.forEach(e => {
      const rowClass = e.isCut || e.pos === 'CUT' || e.pos === 'NF' || e.pos === 'WD' || e.pos === 'DQ' ? ' class="cut-row"' : '';
      const posDisplay = e.pos === 'CUT' ? 'CUT' : (e.pos === 'NF' ? 'NF' : (e.pos === 'WD' ? 'WD' : (e.pos === 'DQ' ? 'DQ' : e.pos)));
      tableHTML += `<tr${rowClass}>`;
      tableHTML += `<td class="player">${e.player}</td>`;
      tableHTML += `<td class="golfer">${e.golfer}</td>`;
      tableHTML += `<td class="pos">${posDisplay}</td>`;
      tableHTML += `<td class="total">${e.total}</td>`;
      tableHTML += `<td class="thru">${e.thru}</td>`;
      tableHTML += `<td class="today">${e.today}</td>`;
      tableHTML += `<td class="total">${e.estimatedPayout}</td>`;
      tableHTML += `</tr>`;
    });

    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;
    statusEl.textContent = 'Live';
    statusEl.style.color = '#2ecc71';

  } catch (err) {
    container.innerHTML = '<span style="color:#e74c3c;">Error loading live data (tournament may not be in progress).</span>';
    statusEl.textContent = 'Failed';
    statusEl.style.color = '#e74c3c';
    console.error(err);
  }
}

function populateTournamentSelect() {
  const select = document.getElementById('tournamentSelect');
  const currentValue = select.value;
  select.innerHTML = '';

  TOURNAMENTS.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    const scored = state.scoredTournaments.includes(t.id);
    opt.textContent = `${t.name}${t.isMajor ? ' (Major)' : ''}${scored ? ' ✓' : ''}`;
    select.appendChild(opt);
  });

  if (currentValue) select.value = currentValue;
}

// ===== PICK MANAGEMENT, SCORING, DATA MANAGEMENT, KEYBOARD SHORTCUTS =====
let currentPickContext = { pIdx: null, tId: null };

function openPickModal(pIdx, tId) {
  const tournament = TOURNAMENTS.find(t => t.id === tId);
  const participantName = state.participants[pIdx];

  currentPickContext = { pIdx, tId };

  document.getElementById('pickModalTitle').textContent = participantName;
  document.getElementById('pickModalSub').textContent = tournament.name;

  const key = `${pIdx}-${tId}`;
  const existing = state.picks[key];
  const input = document.getElementById('golferInput');
  input.value = existing ? existing.golfer : '';

  const valMsg = document.getElementById('validationMsg');
  valMsg.style.display = 'none';
  valMsg.textContent = '';

  const usedGolfers = getUsedGolfers(pIdx, tId);
  const usedList = document.getElementById('usedGolfersList');
  usedList.innerHTML = '';
  const section = document.getElementById('usedGolfersSection');

  if (usedGolfers.length > 0) {
    section.style.display = 'block';
    usedGolfers.forEach(g => {
      const li = document.createElement('li');
      li.textContent = g;
      usedList.appendChild(li);
    });
  } else {
    section.style.display = 'none';
  }

  document.getElementById('pickModal').classList.add('active');
  input.focus();
  input.select();
}

function closePickModal() {
  document.getElementById('pickModal').classList.remove('active');
  currentPickContext = { pIdx: null, tId: null };
}

function getUsedGolfers(pIdx, excludeTId) {
  const used = [];
  TOURNAMENTS.forEach(t => {
    if (t.id === excludeTId) return;
    const key = `${pIdx}-${t.id}`;
    const pick = state.picks[key];
    if (pick) used.push(pick.golfer);
  });
  return used.sort();
}

function validatePick(pIdx, tId, golferName) {
  if (!golferName || !golferName.trim()) {
    return { valid: false, message: 'Please enter a golfer name.' };
  }
  const normalized = golferName.trim();
  const usedGolfers = getUsedGolfers(pIdx, tId);
  const duplicate = usedGolfers.find(g => g.toLowerCase() === normalized.toLowerCase());
  if (duplicate) {
    return { valid: false, message: `"${duplicate}" has already been picked this season.` };
  }
  return { valid: true, message: '' };
}

function savePick() {
  const { pIdx, tId } = currentPickContext;
  if (pIdx === null) return;

  const golferName = document.getElementById('golferInput').value.trim();
  if (!golferName) {
    document.getElementById('validationMsg').textContent = 'Please enter a golfer name.';
    document.getElementById('validationMsg').style.display = 'block';
    return;
  }

  const validation = validatePick(pIdx, tId, golferName);
  if (!validation.valid) {
    document.getElementById('validationMsg').textContent = validation.message;
    document.getElementById('validationMsg').style.display = 'block';
    return;
  }

  const key = `${pIdx}-${tId}`;
  const existing = state.picks[key];

  if (existing && existing.golfer.toLowerCase() !== golferName.toLowerCase() && existing.earnings != null) {
    state.picks[key] = { golfer: golferName, earnings: null, position: null };
  } else if (existing) {
    existing.golfer = golferName;
  } else {
    state.picks[key] = { golfer: golferName, earnings: null, position: null };
  }

  saveState();
  renderAll();
  closePickModal();
}

function clearPick() {
  const { pIdx, tId } = currentPickContext;
  if (pIdx === null) return;
  const key = `${pIdx}-${tId}`;
  delete state.picks[key];
  saveState();
  renderAll();
  closePickModal();
}

function editParticipantName(pIdx) {
  const current = state.participants[pIdx];
  const newName = prompt('Enter participant name:', current);
  if (newName !== null && newName.trim()) {
    state.participants[pIdx] = newName.trim();
    saveState();
    renderAll();
  }
}

async function getMostRecentCompletedTournamentId() {
  for (let i = TOURNAMENTS.length - 1; i >= 0; i--) {
    const tournament = TOURNAMENTS[i];
    try {
      const url = `https://site.api.espn.com/apis/site/v2/sports/golf/leaderboard?event=${tournament.id}`;
      const res = await fetch(url);
      if (!res.ok) continue;
      const data = await res.json();
      const statusName = data?.events?.[0]?.status?.type?.name || '';
      if (statusName === 'STATUS_FINAL' || statusName === 'STATUS_POST') {
        return tournament.id;
      }
    } catch (err) {
      console.warn('Failed status check for', tournament.id, err);
    }
  }
  return null;
}

async function selectMostRecentCompletedTournamentInDropdown() {
  const select = document.getElementById('tournamentSelect');
  const latestCompletedId = await getMostRecentCompletedTournamentId();
  if (latestCompletedId && TOURNAMENTS.some(t => t.id === latestCompletedId)) {
    select.value = latestCompletedId;
    return latestCompletedId;
  }
  return select.value || TOURNAMENTS[TOURNAMENTS.length - 1].id;
}

async function handleScoreTournament() {
  const select = document.getElementById('tournamentSelect');
  const statusEl = document.getElementById('scoreStatus');
  const selectedCompletedId = await selectMostRecentCompletedTournamentInDropdown();
  const selectedIndex = TOURNAMENTS.findIndex(t => t.id === selectedCompletedId);
  if (selectedIndex < 0) return;

  statusEl.textContent = `Refreshing through ${TOURNAMENTS[selectedIndex].abbr} (0/${selectedIndex + 1})...`;
  statusEl.style.color = '#7f8c9b';

  for (let i = 0; i <= selectedIndex; i++) {
    await scoreTournament(TOURNAMENTS[i].id, { suppressModal: true, suppressStatus: true });
    statusEl.textContent = `Refreshing through ${TOURNAMENTS[selectedIndex].abbr} (${i + 1}/${selectedIndex + 1})...`;
  }

  statusEl.textContent = `Updated ${selectedIndex + 1} tournaments through ${TOURNAMENTS[selectedIndex].name}.`;
  statusEl.style.color = '#2ecc71';
}

async function scoreTournament(tournamentId, options = {}) {
  const { suppressModal = false, suppressStatus = false } = options;
  const tournament = TOURNAMENTS.find(t => t.id === tournamentId);
  const statusEl = document.getElementById('scoreStatus');
  if (!suppressStatus) {
    statusEl.textContent = `Fetching ${tournament.abbr}...`;
    statusEl.style.color = '#7f8c9b';
  }

  try {
    const url = `https://site.api.espn.com/apis/site/v2/sports/golf/leaderboard?event=${tournamentId}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`ESPN returned HTTP ${res.status}`);
    const data = await res.json();

    const competitors = data.events[0].competitions[0].competitors;

    const resultsMap = {};
    competitors.forEach(c => {
      const name = c.athlete.displayName;
      const earningsStr = c.statistics?.[1]?.displayValue || '$0';
      const earnings = parseEarnings(earningsStr);
      const position = c.status?.position?.displayName || '-';
      resultsMap[name.toLowerCase()] = { earnings, position, displayName: name };
    });

    const matchResults = [];
    state.participants.forEach((pName, pIdx) => {
      const key = `${pIdx}-${tournamentId}`;
      const pick = state.picks[key];
      if (pick) {
        const result = resultsMap[pick.golfer.toLowerCase()];
        if (result) {
          pick.earnings = result.earnings;
          pick.position = result.position;
          pick.golfer = result.displayName;
          matchResults.push({ participant: pName, golfer: result.displayName, position: result.position, earnings: result.earnings, matched: true });
        } else {
          const lastName = pick.golfer.trim().split(' ').pop().toLowerCase();
          let found = null;
          for (const [key, val] of Object.entries(resultsMap)) {
            if (key.split(' ').pop() === lastName) {
              if (!found) found = val;
              else { found = null; break; }
            }
          }
          if (found) {
            pick.earnings = found.earnings;
            pick.position = found.position;
            pick.golfer = found.displayName;
            matchResults.push({ participant: pName, golfer: found.displayName, position: found.position, earnings: found.earnings, matched: true });
          } else {
            pick.earnings = 0;
            pick.position = 'NF';
            matchResults.push({ participant: pName, golfer: pick.golfer, position: 'Not Found', earnings: 0, matched: false });
          }
        }
      } else {
        matchResults.push({ participant: pName, golfer: '-', position: '-', earnings: 0, matched: true });
      }
    });

    if (!state.scoredTournaments.includes(tournamentId)) {
      state.scoredTournaments.push(tournamentId);
    }

    saveState();
    renderAll();

    if (!suppressStatus) {
      statusEl.textContent = `${tournament.abbr} scored!`;
      statusEl.style.color = '#2ecc71';
    }

    if (!suppressModal) {
      showScoreResults(tournament.name, matchResults);
    }

  } catch (err) {
    if (!suppressStatus) {
      statusEl.textContent = `Error: ${err.message}`;
      statusEl.style.color = '#e74c3c';
    }
    console.error('Scoring error:', err);
    throw err;
  }
}

function showScoreResults(tournamentName, results) {
  document.getElementById('scoreResultsTitle').textContent = 'Scoring Results';
  document.getElementById('scoreResultsSub').textContent = tournamentName;

  const tbody = document.getElementById('scoreResultsBody');
  tbody.innerHTML = '';

  results.forEach(r => {
    const tr = document.createElement('tr');
    if (!r.matched) tr.classList.add('not-found');
    tr.innerHTML = `
      <td>${r.participant}</td>
      <td>${r.golfer}</td>
      <td style="text-align:center">${r.position}</td>
      <td class="earnings">${formatMoney(r.earnings)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('scoreResultsModal').classList.add('active');
}

function closeScoreResultsModal() {
  document.getElementById('scoreResultsModal').classList.remove('active');
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fantasy-golf-backup.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const parsed = JSON.parse(e.target.result);
      if (!parsed.participants || !Array.isArray(parsed.participants)) {
        throw new Error('Invalid file: missing participants array');
      }
      state.participants = parsed.participants;
      state.picks = parsed.picks || {};
      state.scoredTournaments = parsed.scoredTournaments || [];
      saveState();
      renderAll();
      document.getElementById('scoreStatus').textContent = 'Data imported!';
      document.getElementById('scoreStatus').style.color = '#2ecc71';
    } catch (err) {
      alert('Failed to import: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function resetAllData() {
  if (!confirm('Are you sure you want to reset ALL data? This cannot be undone.')) return;
  if (!confirm('Really delete all picks and scores?')) return;
  state = {
    participants: ['Andrew Vlosak', 'Van Ainalakis', 'Joe Vlosak', 'Ben Wilson', 'Kevin Fleck', 'Bryan Stresney', 'Matt Slavik'],
    picks: {
      '0-401811928': { golfer: 'Si Woo Kim', earnings: null, position: null },
      '0-401811929': { golfer: 'Matt Fitzpatrick', earnings: null, position: null },
      '0-401811930': { golfer: 'Max Greyserman', earnings: null, position: null },
      '0-401811931': { golfer: 'Scottie Scheffler', earnings: null, position: null },
      '0-401811932': { golfer: 'Chris Gotterup', earnings: null, position: null },
      '0-401811933': { golfer: 'Hideki Matsuyama', earnings: null, position: null },

      '1-401811928': { golfer: 'Keegan Bradley', earnings: null, position: null },
      '1-401811929': { golfer: 'J.T. Poston', earnings: null, position: null },
      '1-401811930': { golfer: 'Wyndham Clark', earnings: null, position: null },
      '1-401811931': { golfer: 'Cameron Young', earnings: null, position: null },
      '1-401811932': { golfer: 'Russell Henley', earnings: null, position: null },
      '1-401811933': { golfer: 'Jake Knapp', earnings: null, position: null },

      '2-401811928': { golfer: 'Ben Griffin', earnings: null, position: null },
      '2-401811929': { golfer: 'Robert MacIntyre', earnings: null, position: null },
      '2-401811930': { golfer: 'Chris Gotterup', earnings: null, position: null },
      '2-401811931': { golfer: 'Maverick McNealy', earnings: null, position: null },
      '2-401811932': { golfer: 'Si Woo Kim', earnings: null, position: null },
      '2-401811933': { golfer: 'Rory McIlroy', earnings: null, position: null },

      '3-401811928': { golfer: 'Ben Griffin', earnings: null, position: null },
      '3-401811929': { golfer: 'Russell Henley', earnings: null, position: null },
      '3-401811930': { golfer: 'Ludvig Åberg', earnings: null, position: null },
      '3-401811931': { golfer: 'Xander Schauffele', earnings: null, position: null },
      '3-401811932': { golfer: 'Scottie Scheffler', earnings: null, position: null },
      '3-401811933': { golfer: 'Tommy Fleetwood', earnings: null, position: null },

      '4-401811928': { golfer: 'Ben Griffin', earnings: null, position: null },
      '4-401811929': { golfer: 'Sepp Straka', earnings: null, position: null },
      '4-401811930': { golfer: 'Jason Day', earnings: null, position: null },
      '4-401811931': { golfer: 'Jake Knapp', earnings: null, position: null },
      '4-401811932': { golfer: 'Scottie Scheffler', earnings: null, position: null },
      '4-401811933': { golfer: 'Tommy Fleetwood', earnings: null, position: null },

      '5-401811928': { golfer: 'Harry Hall', earnings: null, position: null },
      '5-401811929': { golfer: 'Si Woo Kim', earnings: null, position: null },
      '5-401811930': { golfer: 'Sam Stevens', earnings: null, position: null },
      '5-401811931': { golfer: 'Cameron Young', earnings: null, position: null },
      '5-401811932': { golfer: 'Akshay Bhatia', earnings: null, position: null },
      '5-401811933': { golfer: 'Tommy Fleetwood', earnings: null, position: null },

      '6-401811928': { golfer: 'Collin Morikawa', earnings: null, position: null },
      '6-401811929': { golfer: 'Patrick Cantlay', earnings: null, position: null },
      '6-401811930': { golfer: 'Chris Gotterup', earnings: null, position: null },
      '6-401811931': { golfer: 'Ben Griffin', earnings: null, position: null },
      '6-401811932': { golfer: 'Tommy Fleetwood', earnings: null, position: null },
      '6-401811933': { golfer: 'Si Woo Kim', earnings: null, position: null }
    },
    scoredTournaments: []
  };
  saveState();
  renderAll();
  document.getElementById('scoreStatus').textContent = 'Data reset.';
  document.getElementById('scoreStatus').style.color = '#f39c12';
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closePickModal();
    closeScoreResultsModal();
  }
  if (e.key === 'Enter' && document.getElementById('pickModal').classList.contains('active')) {
    savePick();
  }
});

document.getElementById('pickModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('pickModal')) closePickModal();
});
document.getElementById('scoreResultsModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('scoreResultsModal')) closeScoreResultsModal();
});

// ===== AUTO-REFRESH & LAST UPDATED =====
let autoRefreshInterval = null;
let countdownInterval = null;
let lastUpdatedTime = null;
let lastUpdatedTickInterval = null;
const AUTO_REFRESH_SECONDS = 60;
let countdownRemaining = AUTO_REFRESH_SECONDS;

function parseTournamentDates(dateStr) {
  // Handles formats like "Jan 15–18, 2026", "Jan 29–Feb 1, 2026", "Apr 30–May 3, 2026"
  const months = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11 };
  const match = dateStr.match(/^(\w+)\s+(\d+)–(?:(\w+)\s+)?(\d+),\s+(\d+)$/);
  if (!match) return null;

  const startMonth = months[match[1]];
  const startDay = parseInt(match[2]);
  const endMonth = match[3] ? months[match[3]] : startMonth;
  const endDay = parseInt(match[4]);
  const year = parseInt(match[5]);

  if (startMonth == null || endMonth == null) return null;

  const startDate = new Date(year, startMonth, startDay);
  const endDate = new Date(year, endMonth, endDay, 23, 59, 59);
  return { startDate, endDate };
}

function isTournamentInProgress(tournament) {
  if (!tournament || !tournament.dates) return false;
  const parsed = parseTournamentDates(tournament.dates);
  if (!parsed) return false;

  const now = new Date();
  return now >= parsed.startDate && now <= parsed.endDate;
}

function updateLastUpdatedDisplay() {
  const el = document.getElementById('lastUpdated');
  if (!el || !lastUpdatedTime) {
    if (el) el.textContent = '';
    return;
  }

  const now = new Date();
  const diffMs = now - lastUpdatedTime;
  const diffSec = Math.floor(diffMs / 1000);

  let timeAgoText;
  if (diffSec < 5) {
    timeAgoText = 'just now';
  } else if (diffSec < 60) {
    timeAgoText = `${diffSec}s ago`;
  } else {
    const diffMin = Math.floor(diffSec / 60);
    timeAgoText = diffMin === 1 ? '1 min ago' : `${diffMin} min ago`;
  }

  el.innerHTML = `Last updated: <span class="time-ago">${timeAgoText}</span>`;
}

function startLastUpdatedTick() {
  if (lastUpdatedTickInterval) clearInterval(lastUpdatedTickInterval);
  lastUpdatedTickInterval = setInterval(updateLastUpdatedDisplay, 5000);
}

function updateCountdownDisplay() {
  const el = document.getElementById('autoRefreshCountdown');
  if (!el) return;

  const checkbox = document.getElementById('autoRefreshCheck');
  if (!checkbox || !checkbox.checked) {
    el.textContent = 'Paused';
    el.classList.add('paused');
    return;
  }

  el.classList.remove('paused');
  el.textContent = `Next refresh in ${countdownRemaining}s`;
}

function startAutoRefresh() {
  stopAutoRefresh();

  const select = document.getElementById('currentWeekSelect');
  const tId = select ? select.value : null;
  const tournament = tId ? TOURNAMENTS.find(t => t.id === tId) : null;
  const bar = document.getElementById('autoRefreshBar');

  if (!tournament || !isTournamentInProgress(tournament)) {
    if (bar) bar.style.display = 'none';
    return;
  }

  // Show the auto-refresh bar with all controls
  if (bar) bar.style.display = 'flex';
  document.getElementById('autoRefreshCheck').parentElement.style.display = '';
  document.getElementById('autoRefreshCountdown').style.display = '';

  const checkbox = document.getElementById('autoRefreshCheck');
  if (!checkbox || !checkbox.checked) {
    updateCountdownDisplay();
    return;
  }

  countdownRemaining = AUTO_REFRESH_SECONDS;
  updateCountdownDisplay();

  countdownInterval = setInterval(() => {
    countdownRemaining--;
    if (countdownRemaining <= 0) {
      countdownRemaining = AUTO_REFRESH_SECONDS;
    }
    updateCountdownDisplay();
  }, 1000);

  autoRefreshInterval = setInterval(async () => {
    countdownRemaining = AUTO_REFRESH_SECONDS;
    await _originalLoadLeaderboard();
    lastUpdatedTime = new Date();
    updateLastUpdatedDisplay();
  }, AUTO_REFRESH_SECONDS * 1000);
}

function stopAutoRefresh() {
  if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
}

// Wire up auto-refresh checkbox
document.getElementById('autoRefreshCheck').addEventListener('change', () => {
  startAutoRefresh();
});

// Wire up event select change to re-evaluate auto-refresh
document.getElementById('currentWeekSelect').addEventListener('change', () => {
  stopAutoRefresh();
  const bar = document.getElementById('autoRefreshBar');
  if (bar) bar.style.display = 'none';
  lastUpdatedTime = null;
  updateLastUpdatedDisplay();
});

// Patch loadCurrentWeekLeaderboard to record last-updated time and manage auto-refresh
const _originalLoadLeaderboard = loadCurrentWeekLeaderboard;
loadCurrentWeekLeaderboard = async function() {
  await _originalLoadLeaderboard();
  lastUpdatedTime = new Date();
  updateLastUpdatedDisplay();
  startLastUpdatedTick();

  const bar = document.getElementById('autoRefreshBar');
  const select = document.getElementById('currentWeekSelect');
  const tId = select ? select.value : null;
  const tournament = tId ? TOURNAMENTS.find(t => t.id === tId) : null;
  const inProgress = tournament && isTournamentInProgress(tournament);

  if (bar) bar.style.display = 'flex';

  if (inProgress) {
    document.getElementById('autoRefreshCheck').parentElement.style.display = '';
    document.getElementById('autoRefreshCountdown').style.display = '';
    // Only start auto-refresh if not already running (avoid resetting countdown on each tick)
    if (!autoRefreshInterval) {
      startAutoRefresh();
    }
  } else {
    document.getElementById('autoRefreshCheck').parentElement.style.display = 'none';
    document.getElementById('autoRefreshCountdown').style.display = 'none';
    stopAutoRefresh();
  }
};

async function init() {
  loadState();
  renderAll();
  await selectMostRecentCompletedTournamentInDropdown();
}

init();
</script>
</body>
</html>
